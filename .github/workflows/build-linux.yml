name: build-linux

on:
  workflow_dispatch:
    inputs:
      swoole_or_swow:
        required: true
        description: "定制构建选项: 构建最新版的 swoole 或者 swow （此二者扩展不能同时启用）"
        default: '-swoole +swow'
        type: choice
        options:
        - ' '
        - '-swoole +swoole_latest'
        - '-swoole +swow_latest'
        - '-swoole +swow'
      php_verson:
        required: true
        description: "定制构建选项: 指定 PHP 版本(版本号大于8)"
        default: 8.1.20
        type: choice
        options:
          - 8.0.29
          - 8.1.20
          - 8.2.7
      build_type:
        required: true
        description: "定制构建选项: 指定构建类型"
        default: 'release'
        type: choice
        options:
        - 'release'
        - 'dev'
      build_options:
        required: false
        description: "定制构建选项: 请查看 docs/options.md"
        default: ' '
        type: string
    push:

jobs:
  build:
    name: PHP ${{ inputs.php_verson }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Prepare Source Code
        run: |
          echo $PATH
          env
          docker info
          id -u
          id -g
          who
          cat /etc/os-release
          hostnamectl
          uname -s
          uname -m
          uname -r

          # echo "BUILD_PHP_VERSION=${{ inputs.php_verson }}" >> "$GITHUB_ENV"

          cat /proc/cpuinfo | grep name | cut -f2 -d: | uniq -c
          cat /proc/cpuinfo| grep "physical id"| sort| uniq| wc -l
          cat /proc/cpuinfo | grep "cpu cores" | uniq
          cat /proc/cpuinfo| grep "processor"| wc -l
          lscpu

          export IPV6=$(ip -6 address show  | grep inet6 | awk '{print $2}' | cut -d'/' -f1 | sed -n '2p')
          export IPV4=$(ip -4 address show  | grep inet | grep -v 127.0.0 | awk '{print $2}' | cut -d'/' -f1 | sed -n '1p')
          echo $IPV4
          echo $IPV6
          echo "X_IPV6=${IPV6}" >> $GITHUB_ENV
          echo "X_IPV4=${IPV4}" >> $GITHUB_ENV

          # git submodule update --init

          # 准备数据库容器
          bash sapi/src/UnitTest/scripts/database/start.sh

          # 准备数据库容器
          bash sapi/src/UnitTest/scripts/database/start.sh

      - name: Prepare Libraries and Extensions
        run: |
          set -x
          bash sapi/download-box/download-box-get-archive-from-container.sh

      - name: Prepare
        uses: addnab/docker-run-action@v3
        with:
          image: docker.io/jingjingxyk/build-swoole-cli:all-dependencies-alpine-3.17-php8-v1.0.0-x86_64-20230614T150918Z
          options: -v ${{ github.workspace }}:/work -w /work -e BUILD_PHP_VERSION=${{ inputs.php_verson }}
          run: |
            set -eux
            # export PATH=/work/bin/runtime:$PATH  # 容器已经内置 php 和 composer 容器

            # composer update --no-dev  --optimize-autoloader
            composer update   --optimize-autoloader

            php prepare.php  +inotify +apcu +ds +xlswriter +ssh2 +pgsql +pdo_pgsql -mongodb --with-swoole-pgsql=1 --with-build-type=${{ inputs.build_type }} ${{ inputs.swoole_or_swow }} ${{ inputs.build_options }}  --with-install-library-cached=1

            chmod a+x make.sh
            head -n 20 make.sh

      - name: Build all-library
        uses: addnab/docker-run-action@v3
        with:
          image: docker.io/jingjingxyk/build-swoole-cli:all-dependencies-alpine-3.17-php8-v1.0.0-x86_64-20230614T150918Z
          options: -v ${{ github.workspace }}:/work -w /work
          run: |
            bash sapi/quickstart/mark-install-library-cached.sh
            bash ./make.sh all-library

      - name: Build
        uses: addnab/docker-run-action@v3
        with:
          image: docker.io/jingjingxyk/build-swoole-cli:all-dependencies-alpine-3.17-php8-v1.0.0-x86_64-20230614T150918Z
          options: -v ${{ github.workspace }}:/work -w /work -e BUILD_PHP_VERSION=${{ inputs.php_verson }}
          run: |
            bash ./make.sh config
            bash ./make.sh build
            ./php-src/sapi/cli/php -v
            bash ./make.sh archive

      - name: Show Build Result
        run: |
          currSw="${{ inputs.swoole_or_swow }}"
          currOp="${{ inputs.build_options }}"

          ./php-src/sapi/cli/php -v
          ./php-src/sapi/cli/php -m

          if [[ $currSw =~ *"+swow"* && $currOp =~ *"+swow"*  ]]; then
          ./php-src/sapi/cli/php --ri swoole
          else
          ./php-src/sapi/cli/php --ri swow
          fi

          ./bin/php-${{ inputs.php_verson }}/bin/php -v
          file ./bin/php-${{ inputs.php_verson }}/bin/php
          readelf -h ./bin/php-${{ inputs.php_verson }}/bin/php
          ./bin/php-${{ inputs.php_verson }}/bin/php -r "echo PHP_VERSION;"

          if [[ $currSw =~ *"+swow"* && $currOp =~ *"+swow"*  ]]; then
          ./bin/php-${{ inputs.php_verson }}/bin/php ./vendor/bin/phpunit ./sapi/src/UnitTest/MainTest.php  --list-tests
          ./bin/php-${{ inputs.php_verson }}/bin/php ./vendor/bin/phpunit ./sapi/src/UnitTest/MainTest.php
          ./bin/php-${{ inputs.php_verson }}/bin/php ./vendor/bin/phpunit ./sapi/src/UnitTest/SwoolePGSQLTest.php
          fi

      - name: production artifacts
        uses: actions/upload-artifact@v3
        with:
          name: php-cli-linux-x64-${{ inputs.php_verson }}
          retention-days: 7
          path: ./bin/php-${{ inputs.php_verson }}/bin/php

      - name: Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            php-cli-v${{ inputs.php_verson }}-linux-x64.tar.xz
